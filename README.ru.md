Менеджер профилей и вкладок
Сервер на Node.js для управления профилями и вкладками Chrome, предназначенный для работы в качестве хоста нативного обмена сообщениями с расширением Chrome. Проект поддерживает переключение профилей, управление вкладками и сохранение страниц в формате MHTML.
Возможности

Управление профилями Chrome и их вкладками.
Сохранение и получение веб-страниц в формате MHTML.
Поддержка нативного обмена сообщениями для взаимодействия с расширением Chrome.
Настройка через переменные окружения (например, порт).
Сборка в распространяемый исполняемый файл.

Требования

Node.js: Версия 18 или выше (рекомендуется LTS, например, v18.x.x или v20.x.x).
npm: Версия 8 или выше.
Google Chrome: Установлен и настроен с пользовательскими профилями.
SQLite3: Используется для хранения данных.
Git: Для клонирования репозитория.

Установка

Клонируйте репозиторий:
git clone https://github.com/your-username/profile-tabs-manager.git
cd profile-tabs-manager


Установите зависимости:
npm install


Настройте переменные окружения:Создайте файл .env в корне проекта со следующим содержимым:
PORT=3000

При необходимости измените значение PORT.

Настройте нативный обмен сообщениями Chrome:

Поместите файл com.example.chrome_profile_host.json в соответствующую директорию:
Windows: C:\Users\<ВашПользователь>\AppData\Local\Google\Chrome\User Data\NativeMessagingHosts
macOS: ~/Library/Application Support/Google/Chrome/NativeMessagingHosts
Linux: ~/.config/google-chrome/NativeMessagingHosts


Убедитесь, что поле path в com.example.chrome_profile_host.json указывает на node.exe (для разработки) или на скомпилированный бинарный файл (после сборки, например, dist/profile-tabs-manager.exe).
Обновите поле allowed_origins в соответствии с ID вашего расширения Chrome.


Запустите сервер в режиме разработки:
npm start

Сервер запустится на порту, указанном в .env (по умолчанию 3000).


Инструкции по сборке
Для создания распространяемого исполняемого файла:

Установите pkg:Убедитесь, что pkg установлен как dev-зависимость:
npm install --save-dev pkg


Проверьте версию Node.js:Убедитесь, что ваша версия Node.js совместима. Выполните:
node -v

Если используется Node.js v19.x.x, скрипт сборки настроен для node18-win-x64, что совместимо. Для лучшей стабильности рекомендуется обновить до LTS-версии (v18 или v20).

Соберите исполняемый файл:Выполните скрипт сборки для компиляции server.js в standalone-исполняемый файл:
npm run build

Это создаст исполняемый файл в директории dist/ (например, dist/profile-tabs-manager.exe для Windows). Скрипт использует --targets node18-win-x64, так как node19 не поддерживается pkg.

Обновите конфигурацию нативного обмена сообщениями:Измените com.example.chrome_profile_host.json, чтобы указать путь к скомпилированному исполняемому файлу:
"path": "C:\\Users\\<ВашПользователь>\\Desktop\\profile-tabs-manager\\dist\\profile-tabs-manager.exe"


Протестируйте исполняемый файл:Запустите скомпилированный файл:
.\dist\profile-tabs-manager.exe --native-messaging



Настройка для разработки
Для разработки с автоматической перезагрузкой используйте nodemon:

Установите nodemon:
npm install --save-dev nodemon


Запустите с автоматической перезагрузкой:
npm run dev

Это запускает сервер и автоматически перезапускает его при изменении кода.


Структура проекта

server.js: Основной сервер с интеграцией Express и SQLite3.
com.example.chrome_profile_host.json: Конфигурация хоста нативного обмена сообщениями Chrome.
.env: Переменные окружения (например, PORT).
profiles.db: База данных SQLite для хранения профилей и вкладок (создаётся автоматически).
SavedPages/: Директория для хранения MHTML-файлов.
.gitignore: Игнорирует node_modules, .env и другие ненужные файлы.
package.json: Метаданные проекта и скрипты.
dist/: Директория для скомпилированных исполняемых файлов.

Скрипты

npm start: Запускает сервер в продакшен-режиме (node server.js).
npm run dev: Запускает сервер с nodemon для разработки.
npm run build: Компилирует сервер в исполняемый файл с помощью pkg для node18-win-x64.

Зависимости

express: Фреймворк для обработки HTTP-запросов.
sqlite3: База данных для хранения информации о профилях и вкладках.
uuid: Генерация уникальных идентификаторов для профилей.
dotenv: Загрузка переменных окружения из .env.

Dev-зависимости

pkg: Компилирует проекты Node.js в исполняемые файлы.
nodemon: Обеспечивает автоматическую перезагрузку для разработки.

Примечания

Файл .env игнорируется в .gitignore, чтобы избежать утечки чувствительных данных.
Убедитесь, что Chrome установлен и доступен по путям, указанным в server.js.
Сервер кэширует информацию о профилях на 5 минут. Используйте параметр forceRefresh=true в эндпоинте /profiles для принудительного обновления кэша.
MHTML-файлы сохраняются в директории SavedPages/ и связаны с вкладками в базе данных.
Для компиляции используется --targets node18-win-x64, так как pkg не поддерживает node19 напрямую. Это совместимо с Node.js v19.x.x, но рекомендуется обновить до LTS-версии (v18 или v20).

Устранение неполадок

Ошибки базы данных: Убедитесь, что profiles.db доступен для записи и не повреждён.
Chrome не найден: Проверьте, что chromePath в server.js соответствует вашей установке Chrome.
Конфликт портов: Измените PORT в .env, если порт 3000 занят.
Проблемы с нативным обменом сообщениями: Убедитесь, что ID расширения в com.example.chrome_profile_host.json соответствует вашему расширению.
Ошибки компиляции:
Проверьте версию Node.js (node -v) и убедитесь, что она совместима с pkg.
Если возникают ошибки с нативными модулями (например, sqlite3), выполните:npm rebuild sqlite3


Для отладки используйте:npx pkg server.js --targets node18-win-x64 --output dist/profile-tabs-manager --debug





Для дополнительной помощи обратитесь к документации Chrome по нативному обмену сообщениями.